groups:
- name: ctp-slo-alerts
  interval: 30s
  rules:
  - alert: CTPValidationLatencyP99High
    expr: histogram_quantile(0.99, sum(rate(ctp_token_validation_latency_seconds_bucket[5m]))
      by (le)) * 1000 >= 10
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: CTP token validation latency (p99) above 10ms
      description: p99 validation latency >= 10ms for 10 minutes. Check JWK cache,
        CRL backend, and CPU saturation.
  - alert: CTPRevocationPropagationSlowPull
    expr: histogram_quantile(0.95, sum(rate(ctp_revocation_propagation_seconds_bucket{mode="pull"}[5m]))
      by (le)) >= 5
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: CTP revocation propagation (pull) above 5s
      description: Revocation p95 >= 5s (pull). Investigate CRL polling, Redis availability,
        or network partitions.
  - alert: CTPRevocationPropagationSlowPush
    expr: histogram_quantile(0.95, sum(rate(ctp_revocation_propagation_seconds_bucket{mode="push"}[5m]))
      by (le)) >= 1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: CTP revocation propagation (push) above 1s
      description: Revocation p95 >= 1s (push). Inspect WebSocket/SSE channel, broadcaster
        health.
  - alert: CTPValidationErrorRateHigh
    expr: sum(rate(ctp_validation_errors_total[5m])) / sum(rate(ctp_validations_total[5m]))
      > 0.005
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: CTP validation error rate > 0.5%
      description: High validation errors in last 10m. Check malformed tokens, clock
        skew, and JWKS accessibility.
  - alert: CTPServiceDown
    expr: min_over_time(ctp_service_healthy[5m]) < 1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: CTP service health below threshold
      description: Service health metric < 1 for 5 minutes. Investigate pod crashloops,
        DB connectivity, or TLS issues.
  - alert: CTPLedgerAppendLatencyHigh
    expr: histogram_quantile(0.99, sum(rate(ctp_ledger_append_latency_seconds_bucket[5m]))
      by (le)) * 1000 > 100
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: CTP ledger append latency p99 > 100ms
      description: Ledger append exceeding SLO. Check DB locks, IOPS, or backlog size.
